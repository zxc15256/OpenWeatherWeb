<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://webduino.io/components/webduino-js/dist/webduino-all.min.js"></script>
    <script src="https://blockly.webduino.io/webduino-blockly.js"></script>
    <script src="https://blockly.webduino.io/lib/firebase.js"></script>
    <script src="https://blockly.webduino.io/lib/runtime.min.js"></script>
    <script src="https://mokokai.tk/OpenWeatherSide/js/startspeech.js"></script>
    <script scr="https://mokokai.tk/OpenWeatherSide/js/speechQecognition.js"></script>
    <script src="https://mokokai.tk/OpenWeatherSide/js/startspeech.js"></script>
    <script>
        //變數 
        var rgbled;
        var resultAQI;
        //Location
        var mCountry;
        var mCity;
        var mCity2;
        var region;
        var lining;
        //wind
        var chill;
        var direction;
        var speed;
        //Atmosphere
        var humidity;
        var pressure;
        var rising;
        var visibility;
        //Astronomy
        var sunrise;
        var sunset;
        //Condition
        var date;
        var day;
        var high;
        var low;
        var temp;
        var code;
        var pushTime;
        var publish_time;
        var url2 = '';
        var alreadyspeech2 = false;


        //語音辨識用
        var city = {
            1: "基隆",
            2: "台北",
            3: "新北",
            4: "桃園",
            5: "新竹",
            6: "苗栗",
            7: "台中",
            8: "南投",
            9: "彰化",
            10: "雲林",
            11: "嘉義",
            12: "台南",
            13: "高雄",
            14: "屏東",
            15: "Taitung",
            16: "花蓮",
            17: "宜蘭",
            18: "金門",
            19: '澎湖',
            20: "連江"
        };
        //抓資料需要用經緯度
        var citygps = {
            1: '25.1240262,121.6470147',
            2: '25.0169639,121.2261862',
            3: '24.9861571,121.3645577',
            4: '24.8545491,120.9519978',
            5: '24.6866905,120.892014',
            6: '24.5147969,120.8026139',
            7: '24.2198468,120.6756823',
            8: '23.8405937,120.7023261',
            9: '23.9919519,120.3300822',
            10: '23.6735484,120.294506',
            11: '23.4251135,120.257353',
            12: '23.1226791,120.106233',
            13: '22.6995937,120.1910021',
            14: '22.3895348,120.0680055',
            15: '22.7213708,120.6096737',
            16: '23.7330573,120.8184708',
            17: '24.648688,121.3611287',
            18: '24.4458333,118.3739224',
            19: '23.629355,119.4569846',
            20: '26.1564702,119.9239349'
        };



        function getdataAQI(i) {
            $.ajax({
                url: "http://opendata.epa.gov.tw/ws/Data/REWIQA/?$orderby=County&$skip=0&$top=1000&format=json",
                dataType: "jsonp",
                success: function(response) {
                    resultAQI = response[i].Status;
                    console.log("1:" + resultAQI);
                    if (resultAQI == '良好') {
                        rgbled.setColor('#009900');
                        console.log('green')
                    } else if (resultAQI == '普通') {
                        rgbled.setColor('#ffcc66');
                        console.log('yellow')
                    } else if (resultAQI == '設備維護') {
                        rgbled.setColor('#bb00ff');
                        console.log('purple')
                    } else {
                        rgbled.setColor('#ff0000');
                        console.log('red');
                    }
                },
                error: function(response) {
                    console.log("error");
                }
            });
        }
        boardReady({
            device: 'WGEE'
        }, function(board) {
            board.systemReset();
            board.samplingInterval = 20;
            rgbled = getRGBLed(board, 6, 8, 7);
        });

        function StartAQIsppech() {
            speak("您要查詢哪一個縣市的空氣", ["zh-TW", 1, 1, 1]);
            setTimeout(function() {
                AQIspeech()
            }, 4000);
        }

        function AQIspeech() {
            if (!("webkitSpeechRecognition" in window)) {
                alert("本瀏覽器不支援語音辨識，請更換瀏覽器！(Chrome 25 版以上才支援語音辨識)");
            } else {
                recognition = new webkitSpeechRecognition();
                window._recognition.continuous = false; //在辨識一段話完成之後就會結束辨識。
                window._recognition.interimResults = true; //在我們講話的當下就會即時辨識
                window._recognition.lang = "cmn-Hant-TW"; //語系

                window._recognition.onstart = function() {
                    console.log("Start recognize...");
                    alreadyspeech2 = true;
                };
                window._recognition.onend = function() {
                    console.log("Stop recognize");
                };

                window._recognition.onresult = function(event, result) {
                    result = {};
                    result.resultLength = event.results.length - 1;
                    result.resultTranscript = event.results[result.resultLength][0].transcript;
                    if (event.results[result.resultLength].isFinal === true) {
                        console.log(result.resultTranscript);
                        for (var i in city) {
                            if (result.resultTranscript == "台東") {
                                result.resultTranscript = "Taitung"
                            }
                            if (result.resultTranscript.indexOf(city[i]) !== -1 && alreadyspeech2) { // 如果字串包含台灣'縣市'的話，回饋
                                //基隆
                                if (city[i] == city[1]) {
                                    getdataAQI(31);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //台北
                                else if (city[i] == city[2]) {
                                    getdataAQI(62);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //新北
                                else if (city[i] == city[3]) {
                                    getdataAQI(47);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //桃園
                                else if (city[i] == city[4]) {
                                    getdataAQI(13);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                }
                                //新竹
                                else if (city[i] == city[5]) {
                                    getdataAQI(48);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //苗栗
                                else if (city[i] == city[6]) {
                                    getdataAQI(11);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //台中
                                else if (city[i] == city[7]) {
                                    getdataAQI(57);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //南投
                                else if (city[i] == city[8]) {
                                    getdataAQI(6);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //彰化
                                else if (city[i] == city[9]) {
                                    getdataAQI(54);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //雲林
                                else if (city[i] == city[10]) {
                                    getdataAQI(34);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //嘉義
                                else if (city[i] == city[11]) {
                                    getdataAQI(51);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //台南
                                else if (city[i] == city[12]) {
                                    getdataAQI(74);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //高雄
                                else if (city[i] == city[13]) {
                                    getdataAQI(27);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //屏東
                                else if (city[i] == city[14]) {
                                    getdataAQI(7);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //台東
                                else if (city[i] == city[15]) {
                                    getdataAQI(70);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //花蓮
                                else if (city[i] == city[16]) {
                                    getdataAQI(2);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //宜蘭
                                else if (city[i] == city[17]) {
                                    getdataAQI(0);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //金門
                                else if (city[i] == city[18]) {
                                    getdataAQI(3);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //澎湖
                                else if (city[i] == city[19]) {
                                    getdataAQI(75);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                } //連江
                                else if (city[i] == city[20]) {
                                    getdataAQI(32);
                                    setTimeout(function() {
                                        speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                    }, 6000);
                                    setTimeout(function() {
                                        speak(city[i], ["zh-TW", 1, 1, 1]);
                                    }, 9000);
                                    setTimeout(function() {
                                        speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                    }, 12000);
                                    setTimeout(function() {
                                        speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                        console.log("2:" + resultAQI);
                                    }, 15000);
                                    setTimeout(function() {
                                        alreadyspeech2 = false;;
                                    }, 18000);
                                }
                                break;
                            } else if (result.resultTranscript.indexOf(city[i]) === -1 && alreadyspeech2) {
                                setTimeout(function() {
                                    speak('請說台灣的縣市優', ["zh-TW", 1, 1, 1]);
                                }, 2000);
                                setTimeout(function() {
                                    window._recognition.start();
                                }, 4000);
                            }
                        }
                    } else if (event.results[result.resultLength].isFinal === false) {
                        console.log("final");
                    }
                };
                if (window._recognition.start()) {
                    window._recognition.stop();
                }
                window._recognition.start();
            }
        }

        function StartAirSpeech() {
            speak("您要查詢哪一個縣市的天氣", ["zh-TW", 1, 1, 1]);
            setTimeout(function() {
                AIRspeech()
            }, 4000);
        }

        function getdata() {
            $.get(url, function(e) {
                if (e.query.count == 1) { //如果有抓到count = 1
                    mCountry = e.query.results.channel.location.country;
                    mCity = e.query.results.channel.location.city;
                    direction = e.query.results.channel.wind.direction;
                    chill = e.query.results.channel.wind.chill;
                    speed = e.query.results.channel.wind.speed;
                    humidity = e.query.results.channel.atmosphere.humidity;
                    pressure = e.query.results.channel.atmosphere.pressure;
                    rising = e.query.results.channel.atmosphere.rising;
                    visibility = e.query.results.channel.atmosphere.visibility;
                    sunrise = e.query.results.channel.astronomy.sunrise;
                    sunset = e.query.results.channel.astronomy.sunset;
                    date = e.query.results.channel.item.forecast[0].date;
                    day = e.query.results.channel.item.forecast[0].day;
                    high = e.query.results.channel.item.forecast[0].high;
                    low = e.query.results.channel.item.forecast[0].low;
                    temp = e.query.results.channel.item.condition.temp;
                    code = e.query.results.channel.item.forecast[0].code;
                    pushTime = e.query.results.channel.item.pubDate;
                    publish_time = e.query.results.channel.lastBuildDate;
                } else { //沒抓到直到抓到為止
                    getdata();
                }
            })
        }

        function AIRspeech() {
            if (!("webkitSpeechRecognition" in window)) {
                alert("本瀏覽器不支援語音辨識，請更換瀏覽器！(Chrome 25 版以上才支援語音辨識)");
            } else {

                recognition = new webkitSpeechRecognition();
                window._recognition.continuous = false; //在辨識一段話完成之後就會結束辨識。
                window._recognition.interimResults = true; //在我們講話的當下就會即時辨識
                window._recognition.lang = "cmn-Hant-TW"; //語系

                window._recognition.onstart = function() {
                    console.log("Start recognize...");
                    alreadyspeech2 = true;
                };
                window._recognition.onend = function() {
                    console.log("Stop recognize");
                };

                window._recognition.onresult = function(event, result) {
                    result = {};
                    result.resultLength = event.results.length - 1;
                    result.resultTranscript = event.results[result.resultLength][0].transcript;
                    if (event.results[result.resultLength].isFinal === true) {
                        console.log(result.resultTranscript);
                        for (var i in city) {
                            if (result.resultTranscript == "台東") {
                                result.resultTranscript = "Taitung"
                            }
                            if (result.resultTranscript.indexOf(city[i]) !== -1 && alreadyspeech2) { // 如果字串包含台灣'縣市'的話，回饋
                                url = "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20weather.forecast%20where%20woeid%20in%20(select%20woeid%20from%20geo.places(1)%20where%20text=\"(" + citygps[i] + ")%22)&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys";
                                getdata();
                                setTimeout(function() {
                                    speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                }, 3000);
                                setTimeout(function() {
                                    speak(city[i], ["zh-TW", 1, 1, 1]);
                                }, 6000);
                                setTimeout(function() {
                                    speak(['最高溫', Math.round((high - 32) * 5 / 9), '度', '最低溫', Math.round((low - 32) * 5 / 9), '度', '現在溫度', Math.round((temp - 32) * 5 / 9), '度', '濕度為', '百分之', humidity], ["zh-TW", 1, 1, 1]);
                                }, 9000);
                                setTimeout(function() {
                                    alreadyspeech2 = false;;
                                }, 25000);
                                break;
                            } else if (result.resultTranscript.indexOf(city[i]) === -1 && alreadyspeech2) {
                                setTimeout(function() {
                                    speak('請說台灣的縣市優', ["zh-TW", 1, 1, 1]);
                                }, 2000);
                                setTimeout(function() {
                                    window._recognition.start();
                                }, 4000);
                            }
                        }
                    } else if (event.results[result.resultLength].isFinal === false) {
                        console.log("final");
                    }
                };
                if (window._recognition.start()) {
                    window._recognition.stop();
                }
                window._recognition.start();
            }
        }

        function askspeech() {
            speak("請問需要什麼樣的服務呢?", ["zh-TW", 1, 1, 1]);
            setTimeout(function() {
                choosespeech()
            }, 3000);
        }

        function choosespeech() {
            if (!("webkitSpeechRecognition" in window)) {
                alert("本瀏覽器不支援語音辨識，請更換瀏覽器！(Chrome 25 版以上才支援語音辨識)");
            } else {
                window._recognition = new webkitSpeechRecognition();
                window._recognition.continuous = false; //在辨識一段話完成之後就會結束辨識。
                window._recognition.interimResults = true; //在我們講話的當下就會即時辨識
                window._recognition.lang = "cmn-Hant-TW"; //語系

                window._recognition.onstart = function() {
                    console.log("Start recognize...");
                    alreadyspeech = true;
                };

                window._recognition.onend = function() {
                    console.log("Stop recognize");
                };


                window._recognition.onresult = function(event, result) {
                    result = {};
                    result.resultLength = event.results.length - 1;
                    result.resultTranscript = event.results[result.resultLength][0].transcript;
                    if (event.results[result.resultLength].isFinal === true) {
                        console.log(result.resultTranscript);
                        if (result.resultTranscript.indexOf("天氣") !== -1) {
                            StartAirSpeech();
                            AIRspeech();
                        } else if (result.resultTranscript.indexOf("空氣") !== -1) {
                            StartAQIsppech();
                            AQIspeech();
                        }
                    } else if (event.results[result.resultLength].isFinal === false) {
                        console.log("final");
                    }
                };
                if (window._recognition.start()) {
                    window._recognition.stop();
                }
                window._recognition.start();
            }
        }
    </script>

</head>

<body>
    <button id='ask' onclick="askspeech();">詢問</button>
</body>

</html>